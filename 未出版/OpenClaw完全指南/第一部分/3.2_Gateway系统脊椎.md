---
section_id: 3.2
title: Gateway系统脊椎
status: draft
target_words: 2000
word_count: 1950
---

# Gateway：系统的脊椎

如果说Pi Agent是OpenClaw的大脑，那么Gateway（网关）就是它的脊椎——连接一切，支撑一切。

你可能永远不需要直接操作Gateway，但理解它的工作原理，能让你更好地使用和排查OpenClaw。

## Gateway的四大核心职能

### 1. 连接中心

Gateway是整个系统的星型拓扑中心。

```
                    ┌─────────────┐
                    │   Gateway   │
                    └──────┬──────┘
                           │
     ┌─────────┬───────────┼───────────┬─────────┐
     │         │           │           │         │
┌────┴────┐ ┌──┴───┐  ┌────┴────┐  ┌────┴───┐ ┌──┴───┐
│WhatsApp │ │Telegram│ │  Web UI │  │  Agent │ │Skills│
└─────────┘ └───────┘  └─────────┘  └────────┘ └──────┘
```

所有的外部客户端和内部组件，都必须通过Gateway进行通信，而不是直接互连。

**为什么这样设计？**

- 统一管理：所有连接都在一个地方管理
- 协议转换：不同渠道（WhatsApp用不同API）可以统一处理
- 会话隔离：不同渠道的会话互不干扰
- 安全控制：所有请求都经过Gateway的权限检查

### 2. 会话管理

Gateway维护着所有会话（Session）的状态。

什么是会话？

```
用户A在Telegram发送："帮我整理文件"
    → 创建会话A，分配给Agent实例1

用户B在WhatsApp发送："查一下天气"
    → 创建会话B，分配给Agent实例2

用户A又发送："整理好了吗？"
    → 路由到会话A，Agent实例1继续处理
```

会话管理包括：
- 会话创建：新用户发消息时创建会话
- 会话路由：将消息路由到正确的Agent实例
- 会话持久化：保存会话历史，支持断线重连
- 会话清理：超时的会话自动清理

### 3. 任务调度

Gateway内置了一个Cron调度器，可以触发定时任务。

```json
// 定时任务配置
{
  "crons": {
    "daily_briefing": {
      "schedule": "0 9 * * *",
      "action": "generate_daily_briefing"
    },
    "weekly_report": {
      "schedule": "0 18 * * 5",
      "action": "generate_weekly_report"
    }
  }
}
```

这个配置的意思是：
- 每天早上9点，生成每日简报
- 每周五下午6点，生成每周报告

定时任务的执行流程：

```
Cron触发 ────> Gateway调度 ────> 启动Agent实例 ────> 执行任务 ────> 推送结果
```

### 4. 事件总线

Gateway还充当事件总线的角色，处理各种系统事件：

| 事件类型 | 触发时机 | 处理方式 |
|---------|---------|---------|
| Webhook回调 | 外部服务通知 | 解析并路由到对应Handler |
| 文件变更 | 监控的文件被修改 | 触发对应的Skill |
| 系统告警 | CPU/内存超限 | 发送通知 |
| 错误恢复 | Agent崩溃 | 自动重启 |

## WebSocket：实时通信的秘密武器

Gateway使用WebSocket协议与客户端通信，而不是传统的HTTP。

### HTTP vs WebSocket

**传统HTTP（请求-响应模式）**：

```
客户端：服务器，有什么新消息吗？
服务器：没有
... (1秒后)
客户端：服务器，有什么新消息吗？
服务器：没有
... (1秒后)
客户端：服务器，有什么新消息吗？
服务器：有了！任务完成了！
```

这种方式叫轮询（Polling），效率很低。

**WebSocket（长连接模式）**：

```
客户端 <═══════════════> 服务器
       (保持连接)

服务器：任务完成了！（主动推送）
客户端：收到！
```

WebSocket建立连接后保持打开状态，服务器可以随时主动推送消息。

### 实际效果

**场景：AI帮你处理邮件**

```
09:00 你：帮我处理今天的邮件
09:00 OpenClaw：好的，开始处理...
      (后台运行，你去做别的事)

09:15 (你在做其他工作)
      OpenClaw主动推送：处理完成！整理了127封邮件，
      其中3封需要你关注。

09:15 你：哪3封？
09:15 OpenClaw：来自boss@company.com的邮件...
```

如果没有WebSocket的主动推送能力，你需要不断刷新或询问"处理好了吗"。

## 18789端口：数字背后的故事

Gateway默认监听127.0.0.1:18789。

为什么是18789？

据说Peter Steinberger选择这个端口是因为：
- 18789是一个质数（不容易与其他服务冲突）
- 在常用端口范围之外（避免与HTTP、SSH等冲突）
- 好记

### 端口绑定地址的含义

```
127.0.0.1:18789  →  只监听本地回环，外部无法访问
0.0.0.0:18789    →  监听所有网卡，外部可以访问
192.168.1.100:18789 →  只监听特定IP
```

OpenClaw默认绑定127.0.0.1，这是Loopback-First安全策略的体现。

### 如何检查Gateway是否正常运行

```bash
# 检查端口是否在监听
lsof -i :18789

# 或
netstat -an | grep 18789

# 输出应该类似：
# COMMAND   PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
# node     12345 user   22u  IPv6  ...      0t0  TCP localhost:18789 (LISTEN)
```

## Gateway配置详解

Gateway的配置在`openclaw.json`文件中：

```json
{
  "gateway": {
    "host": "127.0.0.1",
    "port": 18789,
    "auth": {
      "type": "pairing",
      "admin_channels": ["telegram:123456789"]
    },
    "rate_limit": {
      "requests_per_minute": 60,
      "burst": 10
    }
  }
}
```

### 关键配置项

| 配置项 | 含义 | 默认值 | 建议 |
|-------|------|-------|------|
| host | 绑定地址 | 127.0.0.1 | 保持默认 |
| port | 监听端口 | 18789 | 可自定义 |
| auth.type | 认证方式 | pairing | 保持默认 |
| rate_limit | 请求限制 | 60/分钟 | 防止滥用 |

### 修改端口

如果你需要修改端口（比如18789被占用）：

```json
{
  "gateway": {
    "port": 28789
  }
}
```

修改后，所有客户端连接地址也要相应更新。

## Gateway的启动过程

当你运行`openclaw start`时，发生了什么？

```
1. 读取配置文件 openclaw.json
       ↓
2. 初始化日志系统
       ↓
3. 加载Skills（扫描skills目录）
       ↓
4. 初始化Gateway
   - 创建WebSocket服务器
   - 绑定到127.0.0.1:18789
       ↓
5. 连接通讯渠道
   - WhatsApp: 扫码登录
   - Telegram: 通过Bot Token连接
   - Discord: 通过Bot Token连接
       ↓
6. 启动Cron调度器
       ↓
7. 启动Agent进程
       ↓
8. 系统就绪，等待消息
```

## 多渠道消息处理

Gateway的一个核心能力是统一处理不同渠道的消息。

```
┌──────────┐     ┌──────────┐     ┌──────────┐
│ WhatsApp │     │ Telegram │     │ Discord  │
│  消息格式A │     │  消息格式B │     │  消息格式C │
└─────┬────┘     └─────┬────┘     └─────┬────┘
      │                │                │
      └────────────────┼────────────────┘
                       ↓
                ┌─────────────┐
                │   Gateway   │
                │  (格式转换)  │
                └──────┬──────┘
                       ↓
                ┌─────────────┐
                │ 统一消息格式  │
                │ {           │
                │   channel,  │
                │   sender,   │
                │   content,  │
                │   timestamp │
                │ }           │
                └──────┬──────┘
                       ↓
                ┌─────────────┐
                │  Pi Agent   │
                └─────────────┘
```

Gateway将不同渠道的消息转换为统一的内部格式，Agent只需要处理一种格式。

## 故障排查：Gateway常见问题

### 问题1：Gateway启动失败

```
Error: Port 18789 is already in use
```

**原因**：端口被其他进程占用

**解决**：
```bash
# 查找占用端口的进程
lsof -i :18789

# 结束进程
kill -9 <PID>
```

### 问题2：客户端无法连接

```
Error: Connection refused
```

**原因**：Gateway没有运行，或绑定地址不正确

**解决**：
```bash
# 检查Gateway状态
openclaw status

# 重启Gateway
openclaw restart
```

### 问题3：消息丢失

**原因**：WebSocket连接断开

**解决**：
- 检查网络连接
- 查看Gateway日志
- 重启客户端

## Gateway的健康检查

Gateway提供了一个健康检查端点：

```bash
# 检查Gateway是否健康
curl http://127.0.0.1:18789/health

# 响应
{
  "status": "healthy",
  "uptime": 86400,
  "connections": 3,
  "agents": 1
}
```

这可以用于监控系统状态。

---

**本节小结**

- Gateway是系统的连接中心、会话管理器、任务调度器和事件总线
- WebSocket实现实时双向通信，支持AI主动推送
- 默认端口18789，绑定127.0.0.1（Loopback-First）
- 支持多渠道消息的统一处理
- 配置文件openclaw.json控制Gateway行为
- 健康检查端点用于监控系统状态
