---
section_id: 12.4
title: Docker沙箱配置
status: draft
target_words: 1500
word_count: 0
---

# Docker沙箱配置

Docker沙箱是保护OpenClaw Agent系统安全的重要工具。通过将Agent运行在隔离的容器环境中，可以有效限制潜在攻击的影响范围。本章将详细介绍如何配置安全的Docker沙箱环境，确保OpenClaw Agent在受控的条件下运行。

## 为什么需要Docker沙箱

OpenClaw Agent具有强大的能力，可以执行代码、访问文件系统和网络。这些能力在带来便利的同时，也引入了安全风险。恶意Skill或代码可能利用这些能力进行攻击。

Docker沙箱提供了一层额外的保护：
- **进程隔离**：Agent运行在独立的进程空间中，与主机系统隔离
- **文件系统隔离**：Agent只能访问明确允许的文件和目录
- **网络隔离**：可以精细控制Agent的网络访问权限
- **资源限制**：防止Agent消耗过多的系统资源
- **不可变基础设施**：容器镜像可以版本控制，确保环境一致性

## 基础Docker配置

### 创建安全的Dockerfile

以下是一个安全的OpenClaw Agent Dockerfile示例：

```dockerfile
FROM python:3.11-slim

# 创建非特权用户
RUN groupadd -r openclaw && useradd -r -g openclaw openclaw

# 安装依赖
RUN apt-get update && apt-get install -y --no-install-recommends \
    git \
    && rm -rf /var/lib/apt/lists/*

# 安装OpenClaw
RUN pip install --no-cache-dir openclaw==4.0.0

# 创建工作目录
WORKDIR /app
RUN chown openclaw:openclaw /app

# 切换到非特权用户
USER openclaw

# 配置环境变量
ENV OPENCLAW_CONFIG_PATH=/app/config
ENV OPENCLAW_DATA_PATH=/app/data
ENV OPENCLAW_LOG_LEVEL=INFO

# 健康检查
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD python -c "import openclaw; openclaw.health_check()" || exit 1

# 暴露端口（如果需要）
EXPOSE 8080

# 启动命令
CMD ["python", "-m", "openclaw.agent"]
```

关键安全要点：
- 使用官方的、最小化的基础镜像
- 创建并使用非特权用户运行Agent
- 清理不必要的包和缓存
- 设置适当的健康检查

### 运行安全容器

使用以下命令以安全配置运行容器：

```bash
docker run -d \
  --name openclaw-agent \
  --read-only \
  --tmpfs /tmp:noexec,nosuid,size=100m \
  --security-opt no-new-privileges:true \
  --security-opt seccomp=./seccomp-profile.json \
  --cap-drop ALL \
  --cap-add CHOWN \
  --network openclaw-network \
  -v /host/config:/app/config:ro \
  -v /host/data:/app/data \
  -p 127.0.0.1:8080:8080 \
  openclaw-agent:latest
```

关键安全选项解释：
- `--read-only`：使根文件系统只读，防止恶意代码修改系统文件
- `--tmpfs`：使用内存文件系统作为临时目录，限制大小并禁用执行
- `--security-opt no-new-privileges`：防止进程获取额外权限
- `--security-opt seccomp`：使用自定义seccomp配置文件限制系统调用
- `--cap-drop ALL`：移除所有Linux capabilities
- `--cap-add CHOWN`：只添加必要的capability
- `--network`：使用自定义网络进行隔离
- `-v`挂载选项中的`:ro`：只读挂载配置目录

## 高级安全配置

### Seccomp配置文件

Seccomp（Secure Computing Mode）可以限制容器可以使用的系统调用。以下是一个适合OpenClaw Agent的seccomp配置文件：

```json
{
  "defaultAction": "SCMP_ACT_ERRNO",
  "architectures": ["SCMP_ARCH_X86_64", "SCMP_ARCH_X86"],
  "syscalls": [
    {
      "names": [
        "accept", "accept4", "access", "adjtimex", "alarm", "bind",
        "brk", "capget", "capset", "chdir", "chmod", "chown", "chown32",
        "clock_getres", "clock_gettime", "clock_nanosleep", "close",
        "connect", "copy_file_range", "creat", "dup", "dup2", "dup3",
        "epoll_create", "epoll_create1", "epoll_ctl", "epoll_pwait",
        "epoll_wait", "eventfd", "eventfd2", "execve", "execveat",
        "exit", "exit_group", "faccessat", "fadvise64", "fadvise64_64",
        "fallocate", "fanotify_mark", "fchdir", "fchmod", "fchmodat",
        "fchown", "fchown32", "fchownat", "fcntl", "fcntl64", "fdatasync",
        "fgetxattr", "flistxattr", "flock", "fork", "fremovexattr",
        "fsetxattr", "fstat", "fstat64", "fstatat64", "fstatfs",
        "fstatfs64", "fsync", "ftruncate", "ftruncate64", "futex",
        "getcpu", "getcwd", "getdents", "getdents64", "getegid",
        "getegid32", "geteuid", "geteuid32", "getgid", "getgid32",
        "getgroups", "getgroups32", "getitimer", "getpeername",
        "getpgid", "getpgrp", "getpid", "getppid", "getpriority",
        "getrandom", "getresgid", "getresgid32", "getresuid",
        "getresuid32", "getrlimit", "get_robust_list", "getrusage",
        "getsid", "getsockname", "getsockopt", "get_thread_area",
        "gettid", "gettimeofday", "getuid", "getuid32", "getxattr",
        "inotify_add_watch", "inotify_init", "inotify_init1",
        "inotify_rm_watch", "io_cancel", "ioctl", "io_destroy",
        "io_getevents", "io_pgetevents", "ioprio_get", "ioprio_set",
        "io_setup", "io_submit", "io_uring_enter", "io_uring_register",
        "io_uring_setup", "kill", "lchown", "lchown32", "lgetxattr",
        "link", "linkat", "listen", "listxattr", "llistxattr", "lremovexattr",
        "lseek", "lsetxattr", "lstat", "lstat64", "madvise", "memfd_create",
        "mincore", "mkdir", "mkdirat", "mknod", "mknodat", "mlock",
        "mlock2", "mlockall", "mmap", "mmap2", "mprotect", "mq_getsetattr",
        "mq_notify", "mq_open", "mq_timedreceive", "mq_timedsend",
        "mq_unlink", "mremap", "msgctl", "msgget", "msgrcv", "msgsnd",
        "msync", "munlock", "munlockall", "munmap", "nanosleep",
        "newfstatat", "open", "openat", "pause", "pipe", "pipe2",
        "poll", "ppoll", "prctl", "pread64", "preadv", "preadv2",
        "prlimit64", "pselect6", "pwrite64", "pwritev", "pwritev2",
        "read", "readahead", "readdir", "readlink", "readlinkat",
        "readv", "recv", "recvfrom", "recvmmsg", "recvmsg", "remap_file_pages",
        "removexattr", "rename", "renameat", "renameat2", "restart_syscall",
        "rmdir", "rt_sigaction", "rt_sigpending", "rt_sigprocmask",
        "rt_sigqueueinfo", "rt_sigreturn", "rt_sigsuspend", "rt_sigtimedwait",
        "rt_tgsigqueueinfo", "sched_getaffinity", "sched_getattr",
        "sched_getparam", "sched_get_priority_max", "sched_get_priority_min",
        "sched_getscheduler", "sched_rr_get_interval", "sched_setaffinity",
        "sched_setattr", "sched_setparam", "sched_setscheduler",
        "sched_yield", "seccomp", "select", "semctl", "semget", "semop",
        "semtimedop", "send", "sendfile", "sendfile64", "sendmmsg",
        "sendmsg", "sendto", "setfsgid", "setfsgid32", "setfsuid",
        "setfsuid32", "setgid", "setgid32", "setgroups", "setgroups32",
        "setitimer", "setpgid", "setpriority", "setregid", "setregid32",
        "setresgid", "setresgid32", "setresuid", "setresuid32",
        "setreuid", "setreuid32", "setrlimit", "set_robust_list",
        "setsid", "setsockopt", "set_thread_area", "set_tid_address",
        "setuid", "setuid32", "setxattr", "shmat", "shmctl", "shmdt",
        "shmget", "shutdown", "sigaltstack", "signalfd", "signalfd4",
        "sigpending", "sigprocmask", "sigreturn", "socket", "socketcall",
        "socketpair", "splice", "stat", "stat64", "statfs", "statfs64",
        "statx", "symlink", "symlinkat", "sync", "sync_file_range",
        "syncfs", "sysinfo", "tee", "tgkill", "time", "timer_create",
        "timer_delete", "timer_getoverrun", "timer_gettime", "timer_settime",
        "timerfd_create", "timerfd_gettime", "timerfd_settime", "times",
        "tkill", "truncate", "truncate64", "ugetrlimit", "umask",
        "uname", "unlink", "unlinkat", "utime", "utimensat", "utimes",
        "vfork", "wait4", "waitid", "waitpid", "write", "writev"
      ],
      "action": "SCMP_ACT_ALLOW"
    }
  ]
}
```

这个配置文件允许大多数常见的系统调用，但禁用了危险的调用如`mount`、`pivot_root`和`ptrace`。

### 使用Docker Compose

对于更复杂的部署，可以使用Docker Compose来管理多个容器：

```yaml
version: '3.8'

services:
  openclaw-agent:
    image: openclaw-agent:latest
    container_name: openclaw-agent
    read_only: true
    user: "999:999"
    security_opt:
      - no-new-privileges:true
      - seccomp:./seccomp-profile.json
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
      - /var/tmp:noexec,nosuid,size=50m
    volumes:
      - ./config:/app/config:ro
      - ./data:/app/data
      - agent-logs:/app/logs
    networks:
      - openclaw-network
    environment:
      - OPENCLAW_LOG_LEVEL=INFO
      - OPENCLAW_SANDBOX_MODE=strict
    healthcheck:
      test: ["CMD", "python", "-c", "import openclaw; openclaw.health_check()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  # 可选：使用单独的容器运行不可信Skill
  skill-sandbox:
    image: openclaw-skill-sandbox:latest
    container_name: openclaw-skill-sandbox
    read_only: true
    network_mode: none  # 完全禁用网络
    cap_drop:
      - ALL
    tmpfs:
      - /tmp:noexec,nosuid,size=50m
    volumes:
      - skill-data:/data
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
    profiles:
      - sandbox

volumes:
  agent-logs:
  skill-data:

networks:
  openclaw-network:
    driver: bridge
    internal: false
    ipam:
      config:
        - subnet: 172.20.0.0/16
```

### 使用gVisor增强隔离

对于需要更高安全级别的场景，可以考虑使用gVisor。gVisor是一个用户空间内核，提供了额外的隔离层。

配置Docker使用gVisor运行时：

```bash
# 安装gVisor
(
  set -e
  ARCH=$(uname -m)
  URL=https://storage.googleapis.com/gvisor/releases/release/latest
  wget ${URL}/${ARCH}/runsc ${URL}/${ARCH}/runsc.sha512 \
    ${URL}/${ARCH}/containerd-shim-runsc-v1 ${URL}/${ARCH}/containerd-shim-runsc-v1.sha512
  sha512sum -c runsc.sha512 -c containerd-shim-runsc-v1.sha512
  rm -f *.sha512
  chmod a+rx runsc containerd-shim-runsc-v1
  sudo mv runsc containerd-shim-runsc-v1 /usr/local/bin
)

# 配置Docker运行时
sudo /usr/local/bin/runsc install
sudo systemctl reload docker
```

使用gVisor运行容器：

```bash
docker run --runtime=runsc -d openclaw-agent:latest
```

## 监控和日志

### 容器日志管理

配置适当的日志收集和保留策略：

```yaml
logging:
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"
    labels: "production_status,environment"
    env: "OS_VERSION,CUDA_VERSION"
```

### 安全监控

使用Falco监控容器的运行时行为：

```yaml
# falco规则示例
- rule: OpenClaw Unauthorized File Access
  desc: Detect unauthorized file access by OpenClaw Agent
  condition:>
    spawned_process and
    container.name = "openclaw-agent" and
    (fd.name contains "/etc/passwd" or
     fd.name contains "/etc/shadow" or
     fd.name contains "/root/")
  output: >
    Unauthorized file access
    (user=%user.name command=%proc.cmdline file=%fd.name)
  priority: WARNING
```

## 最佳实践总结

1. **始终使用非特权用户**运行容器内的进程
2. **启用只读根文件系统**，将可写目录限制在必要的最小范围
3. **使用seccomp**限制可用的系统调用
4. **删除不必要的capabilities**，只保留必需的权限
5. **设置资源限制**，防止资源耗尽攻击
6. **使用网络隔离**，控制容器的网络访问
7. **定期更新**基础镜像和依赖
8. **扫描镜像**中的已知漏洞
9. **监控运行时行为**，检测异常活动
10. **使用gVisor或Kata Containers**增强隔离（高安全场景）

通过遵循这些实践，可以显著提高OpenClaw Agent的安全性，将潜在攻击的影响限制在可控范围内。记住，安全是一个持续的过程，需要定期审查和更新安全配置。
