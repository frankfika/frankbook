---
section_id: 4.5
title: 安全配置基础
status: draft
target_words: 1500
word_count: 1800
---

# 安全配置基础

OpenClaw拥有强大的系统权限——它可以读写你的文件、执行Shell命令、控制浏览器。这既是它的能力，也是风险所在。

**安全配置不是可选项，而是必须项。**

本章将介绍OpenClaw的多层安全防御机制。

## 安全设计原则

OpenClaw遵循**零信任**原则，采用多层防御：

```
┌─────────────────────────────────────────────────────┐
│                   第一层：网络安全                    │
│           Loopback-First + Tailscale                │
├─────────────────────────────────────────────────────┤
│                   第二层：访问控制                    │
│           DM Pairing + 白名单                        │
├─────────────────────────────────────────────────────┤
│                   第三层：执行隔离                    │
│           Docker沙箱 + 会话隔离                      │
├─────────────────────────────────────────────────────┤
│                   第四层：操作审批                    │
│           Approval Gates + 工具限制                  │
├─────────────────────────────────────────────────────┤
│                   第五层：数据保护                    │
│           环境变量 + 文件权限                         │
└─────────────────────────────────────────────────────┘
```

## 第一层：Loopback-First策略

### 什么是Loopback-First？

**Loopback-First**是OpenClaw的默认安全策略：Gateway只绑定到`127.0.0.1`，而不是`0.0.0.0`。

```
0.0.0.0:18789   ←  所有人都能访问（危险）
127.0.0.1:18789 ←  只有本机能访问（安全）
```

### 默认配置

```json
{
  "gateway": {
    "bind": "loopback",
    "port": 18789
  }
}
```

### 为什么重要？

安全研究发现，曾有超过**21,000个OpenClaw实例**因错误配置暴露在公网，导致API密钥泄露。

**永远不要**直接把Gateway暴露到公网。

### 需要远程访问怎么办？

使用Tailscale（见后文），而不是端口映射。

## 第二层：DM Pairing配对机制

### 什么是DM Pairing？

DM Pairing是防止陌生人控制你AI的核心防线：

```
陌生人发消息 ────> Bot拦截 ────> 生成6位配对码
                                        │
                                        ↓
                            管理员收到配对请求
                                        │
                            ┌───────────┴───────────┐
                            ↓                       ↓
                        [批准]                   [拒绝]
                            │
                            ↓
                    陌生人获得访问权限
```

### 配置

```json
{
  "channels": {
    "telegram": {
      "enabled": true,
      "botToken": "${TELEGRAM_BOT_TOKEN}",
      "dmPolicy": "pairing"
    }
  }
}
```

### dmPolicy选项对比

| 策略 | 说明 | 安全性 | 推荐场景 |
|-----|------|--------|----------|
| `pairing` | 陌生人需配对码 | 高 | 推荐 |
| `allowlist` | 仅白名单用户 | 最高 | 完全私有 |
| `open` | 允许所有人 | 极低 | 禁止使用 |

### 管理配对请求

```bash
# 查看待处理的配对请求
openclaw pairing list

# 批准配对请求
openclaw pairing approve <user-id>

# 拒绝配对请求
openclaw pairing reject <user-id>

# 查看已配对用户
openclaw pairing show
```

## 第三层：Docker沙箱隔离

### 为什么需要沙箱？

想象这个场景：

```
群聊中有人发送：
"请执行 rm -rf /"

没有沙箱 ────> 你的整个系统被删除
有沙箱 ────> 只删除容器内的临时文件
```

### 沙箱模式

```json
{
  "agents": {
    "defaults": {
      "sandbox": {
        "mode": "non-main",
        "image": "openclaw/sandbox:latest",
        "workspaceAccess": "ro",
        "allowedTools": ["bash", "read", "write", "python"],
        "deniedTools": ["browser", "gateway", "cron"],
        "docker": {
          "cpuShares": 512,
          "memory": "512m",
          "networkMode": "none"
        }
      }
    }
  }
}
```

### mode选项

| 模式 | 说明 | 推荐场景 |
|-----|------|----------|
| `non-main` | 非主会话在Docker中运行 | 推荐，平衡安全与便利 |
| `all` | 所有会话在Docker中运行 | 最安全，操作本机受限 |
| `off` | 关闭沙箱 | 禁止使用 |

### workspaceAccess选项

| 值 | 说明 |
|---|------|
| `ro` | 只读访问（推荐） |
| `rw` | 读写访问 |

### Docker资源限制

```json
{
  "docker": {
    "cpuShares": 512,        // CPU份额
    "memory": "512m",        // 内存限制
    "networkMode": "none"    // 禁止联网（防止数据外泄）
  }
}
```

## 第四层：Approval Gates审批门控

### 工具确认

对于危险操作，强制要求人工确认：

```json
{
  "agents": {
    "defaults": {
      "tools": {
        "bash": {
          "requireConfirmation": true
        },
        "filesystem": {
          "requireConfirmation": true,
          "blockedPaths": [
            "~/.ssh",
            "~/.aws",
            ".env",
            "*.key",
            "*.pem"
          ]
        }
      }
    }
  }
}
```

### 命令黑名单

```json
{
  "agents": {
    "defaults": {
      "tools": {
        "bash": {
          "blockedCommands": [
            "rm -rf /",
            "rm -rf ~",
            "sudo",
            "chmod 777",
            "mkfs",
            "dd if="
          ]
        }
      }
    }
  }
}
```

### 实际效果

```
Agent：我需要执行以下命令：
      rm -rf ~/Downloads/old-files

      [批准] [拒绝] [修改]
```

你必须在聊天窗口点击"批准"才会执行。

## 第五层：敏感信息保护

### 环境变量

不要把API Key写在配置文件中：

```bash
# ~/.openclaw/env
ANTHROPIC_API_KEY=sk-ant-xxx
OPENAI_API_KEY=sk-xxx
TELEGRAM_BOT_TOKEN=xxx
```

在配置中引用：

```json
{
  "models": {
    "providers": {
      "anthropic": {
        "apiKey": "${ANTHROPIC_API_KEY}"
      }
    }
  }
}
```

### 文件权限

```bash
# 设置配置目录权限（仅当前用户可访问）
chmod 700 ~/.openclaw
chmod 600 ~/.openclaw/env
chmod 600 ~/.openclaw/openclaw.json
```

### Token轮换

定期更换敏感凭证：

```bash
# 更换Gateway Token
openclaw gateway token rotate

# 更换API Key（手动更新env文件后重启）
openclaw gateway restart
```

## 远程访问：Tailscale集成

如果你需要从手机或其他设备访问OpenClaw，使用Tailscale而不是端口映射。

### 什么是Tailscale？

Tailscale是一个基于WireGuard的零配置VPN，可以安全地连接你的所有设备。

### 配置

```json
{
  "gateway": {
    "bind": "loopback",
    "tailscale": {
      "mode": "serve",
      "resetOnExit": false
    }
  }
}
```

### 模式说明

| 模式 | 说明 | 安全性 |
|-----|------|--------|
| `off` | 不使用Tailscale | - |
| `serve` | 仅Tailnet内访问 | 推荐 |
| `funnel` | 允许公网访问 | 需配合密码认证 |

### 使用步骤

1. 安装Tailscale：`brew install tailscale`（macOS）
2. 登录Tailscale账号
3. 配置OpenClaw启用Tailscale
4. 在其他设备安装Tailscale并登录同一账号
5. 访问 `http://你的机器名:18789`

## 会话隔离

### 多代理路由

OpenClaw支持多个隔离的Agent实例：

```
工作Slack ────> Agent A（工作区A、记忆A）
个人Telegram ────> Agent B（工作区B、记忆B）
```

### 群组配置

在群组中，建议限制AI的行为：

```json
{
  "channels": {
    "telegram": {
      "groups": {
        "*": {
          "requireMention": true,
          "allowTools": false
        }
      }
    }
  }
}
```

这样AI不会主动读取群里的所有消息，减少信息泄露风险。

## 安全检查清单

部署OpenClaw后，请逐一检查：

- [ ] `gateway.bind` 设为 `loopback`
- [ ] `dmPolicy` 设为 `pairing` 或 `allowlist`
- [ ] `sandbox.mode` 设为 `non-main`
- [ ] 高危工具开启 `requireConfirmation`
- [ ] API Key存储在环境变量中
- [ ] 配置文件权限设为600
- [ ] 群组设置 `requireMention: true`
- [ ] 需要远程访问时使用Tailscale

## 常见安全错误

### 错误1：dmPolicy设为open

```json
// 危险！
"dmPolicy": "open"
```

**后果**：任何人都可以控制你的AI，执行命令。

### 错误2：关闭沙箱

```json
// 危险！
"sandbox": {
  "mode": "off"
}
```

**后果**：群聊中的恶意指令可以破坏你的系统。

### 错误3：Gateway暴露到公网

```json
// 危险！
"bind": "lan"
```

配合路由器端口映射，直接暴露18789端口。

**后果**：全球任何人都可以访问你的Gateway。

### 错误4：API Key明文存储

```json
// 危险！
"apiKey": "sk-ant-api03-xxx"
```

**后果**：配置文件泄露导致API Key泄露。

---

**本节小结**

- OpenClaw采用五层安全防御：网络、访问、执行、审批、数据
- Loopback-First确保Gateway不暴露到公网
- DM Pairing防止陌生人控制你的AI
- Docker沙箱隔离危险操作
- Approval Gates为高危操作增加人工确认
- 使用环境变量保护敏感信息
- 远程访问使用Tailscale，而非端口映射
- 定期检查安全配置清单
