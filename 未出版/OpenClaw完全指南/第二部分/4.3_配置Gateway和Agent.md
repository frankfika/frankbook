---
section_id: 4.3
title: 配置Gateway和Agent
status: draft
target_words: 1500
word_count: 1800
---

# 配置Gateway和Agent

安装完成后，接下来是OpenClaw最重要的配置环节。理解配置文件结构，是掌握OpenClaw的关键。

## 配置文件位置

OpenClaw的核心配置文件位于：

```
~/.openclaw/openclaw.json
```

旧版本可能在 `~/.clawdbot/clawdbot.json`，新版已统一迁移。

### 查看和编辑配置

```bash
# 查看配置文件位置
openclaw config path

# 用编辑器打开配置文件
openclaw config

# 或直接用你喜欢的编辑器
code ~/.openclaw/openclaw.json
vim ~/.openclaw/openclaw.json
```

## 配置文件结构概览

```json
{
  "meta": { ... },        // 元信息
  "general": { ... },     // 通用设置
  "gateway": { ... },     // Gateway配置
  "agents": { ... },      // Agent配置
  "models": { ... },      // 模型配置
  "channels": { ... },    // 渠道配置
  "hooks": { ... }        // 钩子配置
}
```

下面我们逐个模块详细讲解。

## Gateway配置

Gateway是OpenClaw的核心，控制着整个系统的运行。

### 基本配置

```json
{
  "gateway": {
    "mode": "local",           // 运行模式：local 或 remote
    "bind": "loopback",        // 绑定地址
    "port": 18789,             // 监听端口
    "auth": {
      "mode": "token",
      "token": "your-secure-token"  // Web UI访问密码
    }
  }
}
```

### bind字段：重要的安全设置

| 值 | 含义 | 安全性 |
|---|------|--------|
| `loopback` | 仅本机访问（127.0.0.1） | 安全，推荐 |
| `lan` | 允许局域网访问（0.0.0.0） | 需配合防火墙 |

强烈建议：保持默认的 `loopback`，除非你明确需要局域网访问。

### Gateway命令

```bash
# 启动Gateway（后台服务）
openclaw gateway start

# 停止Gateway
openclaw gateway stop

# 重启Gateway
openclaw gateway restart

# 查看状态
openclaw gateway status

# 前台运行（调试用）
openclaw gateway --port 18789
```

### 启动参数

| 参数 | 说明 |
|-----|------|
| `--port <number>` | 覆盖默认端口 |
| `--bind <address>` | 覆盖绑定地址 |
| `--token <string>` | 覆盖认证Token |
| `--allow-unconfigured` | 允许未完全配置时启动 |

## Agent配置

Agent控制着AI助手的行为和能力。

### 基本配置

```json
{
  "agents": {
    "defaults": {
      "model": {
        "primary": "anthropic/claude-3-5-sonnet-20240620"
      },
      "workspace": "~/openclaw/workspace",
      "maxConcurrent": 4,
      "sandbox": {
        "mode": "non-main",
        "workspaceAccess": "ro"
      }
    }
  }
}
```

### workspace：工作目录

工作区存放Agent的记忆、技能和运行时数据：

```
~/openclaw/workspace/
├── MEMORY.md        // 长期记忆
├── SOUL.md          // 人设和性格
├── TOOLS.md         // 工具描述
└── skills/          // 技能目录
    ├── email/
    ├── calendar/
    └── ...
```

### sandbox：沙箱配置

沙箱是OpenClaw的重要安全特性，用于隔离不可信的输入。

```json
{
  "sandbox": {
    "mode": "non-main",           // 沙箱模式
    "image": "openclaw/sandbox:latest",
    "workspaceAccess": "ro",      // 工作区权限
    "allowedTools": ["bash", "read", "write", "python"],
    "deniedTools": ["browser", "gateway", "cron"],
    "docker": {
      "cpuShares": 512,
      "memory": "512m",
      "networkMode": "none"
    }
  }
}
```

**mode选项**：

| 值 | 说明 | 推荐场景 |
|---|------|----------|
| `non-main` | 非主会话在Docker中运行 | 推荐，平衡安全与便利 |
| `all` | 所有会话在Docker中运行 | 最安全，操作本机受限 |
| `off` | 关闭沙箱 | 不推荐 |

## 模型配置

OpenClaw支持多种AI模型，可以灵活配置和切换。

### 配置结构

```json
{
  "models": {
    "providers": {
      "anthropic": {
        "apiKey": "${ANTHROPIC_API_KEY}",
        "models": [
          { "id": "claude-3-5-sonnet-20240620", "name": "Claude 3.5 Sonnet" }
        ]
      },
      "openai": {
        "apiKey": "${OPENAI_API_KEY}",
        "models": [
          { "id": "gpt-4o-mini", "name": "GPT-4o Mini" }
        ]
      }
    }
  }
}
```

### API协议类型

OpenClaw支持两种主流API协议：

| 协议 | `api` 值 | 兼容服务 |
|-----|---------|---------|
| OpenAI | `openai-completions` | 硅基流动、DeepSeek、Moonshot、Ollama、vLLM等 |
| Anthropic | `anthropic-messages` | Anthropic、AWS Bedrock Claude等 |

> **重要**：大多数国内服务都兼容OpenAI协议，使用 `api: "openai-completions"` 即可。

### 支持的模型提供商

| 提供商 | 说明 | API协议 |
|-------|------|--------|
| Anthropic | Claude系列 | anthropic-messages |
| OpenAI | GPT系列 | openai-completions |
| Google | Gemini系列 | openai-completions |
| 硅基流动 | 多种开源模型 | openai-completions |
| DeepSeek | 国产推理模型 | openai-completions |
| 月之暗面 | Kimi系列 | openai-completions |
| 智谱AI | GLM系列 | openai-completions |
| 阿里云 | 通义千问 | openai-completions |
| 火山引擎 | 豆包系列 | openai-completions |
| Ollama | 本地模型 | openai-completions |

### 硅基流动（推荐）

硅基流动提供多种开源模型的API服务，性价比高，是国内用户的首选：

```json
{
  "env": { "SILICONFLOW_API_KEY": "sk-xxx..." },
  "agents": {
    "defaults": { "model": { "primary": "siliconflow/Qwen/Qwen2.5-72B-Instruct" } }
  },
  "models": {
    "providers": {
      "siliconflow": {
        "baseUrl": "https://api.siliconflow.cn/v1",
        "apiKey": "${SILICONFLOW_API_KEY}",
        "api": "openai-completions",
        "models": [
          { "id": "Qwen/Qwen2.5-72B-Instruct", "name": "通义千问 2.5 72B" },
          { "id": "deepseek-ai/DeepSeek-V3", "name": "DeepSeek V3" },
          { "id": "deepseek-ai/DeepSeek-R1", "name": "DeepSeek R1", "reasoning": true }
        ]
      }
    }
  }
}
```

### DeepSeek

DeepSeek官方API，支持最新的V3和R1推理模型：

```json
{
  "env": { "DEEPSEEK_API_KEY": "sk-xxx..." },
  "agents": {
    "defaults": { "model": { "primary": "deepseek/deepseek-chat" } }
  },
  "models": {
    "providers": {
      "deepseek": {
        "baseUrl": "https://api.deepseek.com/v1",
        "apiKey": "${DEEPSEEK_API_KEY}",
        "api": "openai-completions",
        "models": [
          { "id": "deepseek-chat", "name": "DeepSeek Chat" },
          { "id": "deepseek-reasoner", "name": "DeepSeek R1", "reasoning": true }
        ]
      }
    }
  }
}
```

### 月之暗面（Kimi）

超长上下文，适合处理大文档：

```json
{
  "env": { "MOONSHOT_API_KEY": "sk-xxx..." },
  "agents": {
    "defaults": { "model": { "primary": "moonshot/moonshot-v1-128k" } }
  },
  "models": {
    "providers": {
      "moonshot": {
        "baseUrl": "https://api.moonshot.cn/v1",
        "apiKey": "${MOONSHOT_API_KEY}",
        "api": "openai-completions",
        "models": [
          { "id": "moonshot-v1-8k", "name": "Moonshot 8K" },
          { "id": "moonshot-v1-32k", "name": "Moonshot 32K" },
          { "id": "moonshot-v1-128k", "name": "Moonshot 128K" }
        ]
      }
    }
  }
}
```

### 智谱AI（GLM）

```json
{
  "env": { "ZHIPU_API_KEY": "xxx..." },
  "agents": {
    "defaults": { "model": { "primary": "zhipu/glm-4-plus" } }
  },
  "models": {
    "providers": {
      "zhipu": {
        "baseUrl": "https://open.bigmodel.cn/api/paas/v4",
        "apiKey": "${ZHIPU_API_KEY}",
        "api": "openai-completions",
        "models": [
          { "id": "glm-4-plus", "name": "GLM-4 Plus" },
          { "id": "glm-4-flash", "name": "GLM-4 Flash" }
        ]
      }
    }
  }
}
```

### 通义千问（阿里云百炼）

```json
{
  "env": { "DASHSCOPE_API_KEY": "sk-xxx..." },
  "agents": {
    "defaults": { "model": { "primary": "dashscope/qwen-max" } }
  },
  "models": {
    "providers": {
      "dashscope": {
        "baseUrl": "https://dashscope.aliyuncs.com/compatible-mode/v1",
        "apiKey": "${DASHSCOPE_API_KEY}",
        "api": "openai-completions",
        "models": [
          { "id": "qwen-max", "name": "通义千问 Max" },
          { "id": "qwen-plus", "name": "通义千问 Plus" },
          { "id": "qwen-turbo", "name": "通义千问 Turbo" }
        ]
      }
    }
  }
}
```

### 火山引擎（豆包）

```json
{
  "env": { "VOLCENGINE_API_KEY": "your-api-key..." },
  "agents": {
    "defaults": { "model": { "primary": "volcengine/doubao-1-5-pro-32k-250115" } }
  },
  "models": {
    "providers": {
      "volcengine": {
        "baseUrl": "https://ark.cn-beijing.volces.com/api/v3",
        "apiKey": "${VOLCENGINE_API_KEY}",
        "api": "openai-completions",
        "models": [
          { "id": "doubao-1-5-pro-32k-250115", "name": "豆包 1.5 Pro 32K" },
          { "id": "doubao-1-5-lite-32k-250115", "name": "豆包 1.5 Lite 32K" }
        ]
      }
    }
  }
}
```

### 本地模型（Ollama）

Ollama是最简单的本地模型运行方式，OpenClaw可以自动发现本地Ollama中的模型：

```bash
# 安装Ollama
# macOS: brew install ollama
# Linux: curl -fsSL https://ollama.com/install.sh | sh

# 拉取模型
ollama pull llama3.3
ollama pull qwen2.5:32b

# 启动服务
ollama serve
```

最简配置：

```json
{
  "env": { "OLLAMA_API_KEY": "ollama-local" },
  "agents": {
    "defaults": { "model": { "primary": "ollama/llama3.3" } }
  }
}
```

> OpenClaw会自动发现本地Ollama中支持工具调用的模型。

手动配置（Ollama运行在非默认端口时）：

```json
{
  "models": {
    "providers": {
      "ollama": {
        "baseUrl": "http://192.168.1.100:11434/v1",
        "apiKey": "ollama-local",
        "api": "openai-completions",
        "models": [
          { "id": "llama3.3", "name": "Llama 3.3" },
          { "id": "qwen2.5:32b", "name": "Qwen 2.5 32B" }
        ]
      }
    }
  }
}
```

### 模型配置字段说明

| 字段 | 必填 | 说明 |
|-----|------|------|
| `baseUrl` | ✅ | API端点地址 |
| `apiKey` | ✅ | API密钥，支持 `${ENV_VAR}` 引用 |
| `api` | ✅ | API协议类型 |
| `models[].id` | ✅ | 模型ID（**不含provider前缀**） |
| `models[].name` | ❌ | 显示名称 |
| `models[].reasoning` | ❌ | 是否支持推理模式，默认false |
| `models[].contextWindow` | ❌ | 上下文窗口大小，默认200000 |

> ⚠️ **重要**：`models[].id` 字段只填写模型名称，**不要包含provider前缀**。
>
> - ✅ 正确：`"id": "qwen-max"`
> - ❌ 错误：`"id": "dashscope/qwen-max"`
>
> 系统会自动组合成完整引用（如 `dashscope/qwen-max`）。

### 模型别名配置

为常用模型设置别名，方便切换：

```json
{
  "agents": {
    "defaults": {
      "model": { "primary": "anthropic/claude-3-5-sonnet-20240620" },
      "models": {
        "anthropic/claude-3-5-sonnet-20240620": { "alias": "main" },
        "anthropic/claude-3-opus-20240229": { "alias": "smart" },
        "openai/gpt-4o-mini": { "alias": "fast" },
        "ollama/qwen2.5-coder:32b": { "alias": "local" }
      }
    }
  }
}
```

切换模型：`/model fast`、`/model local`

## Agent人设配置

通过工作区文件定义Agent的性格和行为。

### SOUL.md：人设定义

```markdown
# Agent人设

你是一个高效、专业的AI助手。

## 性格特点
- 直接、简洁
- 不啰嗦
- 主动提供解决方案

## 专业领域
- Python开发
- 系统运维
- 数据分析

## 工作风格
- 先理解问题，再行动
- 遇到不确定的，主动询问
- 完成后给出简洁总结
```

### MEMORY.md：长期记忆

Agent会自动维护这个文件，你也可以手动编辑：

```markdown
# 用户信息

## 个人偏好
- 偏好Python语言
- 使用VS Code编辑器
- 习惯中文沟通

## 工作背景
- 全栈开发者
- 主要项目：电商平台

## 重要事项
- [2024-01-15] 周五有重要会议
- [2024-01-10] 完成了订单模块的重构
```

## 环境变量配置

OpenClaw支持在配置文件中直接定义环境变量，无需额外创建文件。

### 在配置文件中定义

最新的配置方式是在 `openclaw.json` 的 `env` 字段中直接定义：

```json
{
  "env": {
    "ANTHROPIC_API_KEY": "sk-ant-xxx",
    "OPENAI_API_KEY": "sk-xxx",
    "SILICONFLOW_API_KEY": "sk-xxx",
    "DEEPSEEK_API_KEY": "sk-xxx",
    "DASHSCOPE_API_KEY": "sk-xxx"
  },
  "models": {
    "providers": {
      "siliconflow": {
        "baseUrl": "https://api.siliconflow.cn/v1",
        "apiKey": "${SILICONFLOW_API_KEY}",
        "api": "openai-completions",
        "models": [...]
      }
    }
  }
}
```

### 传统方式：env文件

也可以创建 `~/.openclaw/env` 文件：

```bash
# 国产模型API Keys
SILICONFLOW_API_KEY=sk-xxx
DEEPSEEK_API_KEY=sk-xxx
DASHSCOPE_API_KEY=sk-xxx
MOONSHOT_API_KEY=sk-xxx
ZHIPU_API_KEY=xxx

# 国际模型API Keys
ANTHROPIC_API_KEY=sk-ant-xxx
OPENAI_API_KEY=sk-xxx
```

### CLI命令管理

```bash
# 设置环境变量
openclaw config set env.SILICONFLOW_API_KEY "sk-xxx"

# 设置供应商配置
openclaw config set models.providers.siliconflow.baseUrl "https://api.siliconflow.cn/v1"
openclaw config set models.providers.siliconflow.apiKey "${SILICONFLOW_API_KEY}"
```

### 生效方式

修改环境变量后需要重启Gateway：

```bash
openclaw gateway restart
```

## 模型管理命令

### 查看模型

```bash
# 查看已配置的模型
openclaw models list

# 查看所有可用模型
openclaw models list --all

# 查看模型状态
openclaw models status
```

### 设置默认模型

```bash
# 设置主模型
openclaw models set deepseek/deepseek-chat

# 设置图像模型
openclaw models set-image openai/dall-e-3
```

### 管理回退模型

当主模型不可用时，自动切换到备用模型：

```bash
# 添加回退模型
openclaw models fallbacks add siliconflow/Qwen/Qwen2.5-72B-Instruct

# 查看回退列表
openclaw models fallbacks list

# 清空回退
openclaw models fallbacks clear
```

### 在聊天中切换模型

在Telegram/WhatsApp等渠道中：

```
/model              # 查看当前模型
/model list         # 列出可用模型
/model 1            # 选择第1个模型
/model deepseek/deepseek-chat  # 切换到指定模型
/model status       # 查看详细状态
```

## 配置验证

### 检查配置语法

```bash
openclaw config validate
```

### 查看当前配置

```bash
# 查看完整配置
openclaw config show

# 查看特定部分
openclaw config show gateway
openclaw config show models
```

## 常见配置问题

### 问题1：Gateway启动失败

检查端口是否被占用：
```bash
lsof -i :18789
```

### 问题2：模型调用失败

1. 检查API Key是否正确
2. 检查环境变量是否加载
3. 检查网络连接

### 问题3：配置不生效

1. 确认修改的是正确的配置文件
2. 重启Gateway
3. 清除缓存：`openclaw cache clear`

---

**本节小结**

- 配置文件位于 `~/.openclaw/openclaw.json`
- Gateway配置控制系统的运行方式
- Agent配置控制AI的行为和能力
- 沙箱配置是重要的安全特性
- 支持多种AI模型，可以灵活配置
- 使用环境变量保护敏感信息
- SOUL.md定义人设，MEMORY.md存储长期记忆
